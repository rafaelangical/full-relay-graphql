aliases:
  # Cache Management
  - &restore-yarn-cache
    keys:
      - v0-yarn-cache
  - &save-yarn-cache
    paths:
      - ~/.cache/yarn
    key: v0-yarn-cache

  - &restore-mongodb-binaries-cache
    keys:
      - v0-mongodb-binaries
  - &save-mongodb-binaries-cache
    paths:
      - ~/.mongodb-binaries
    key: v0-mongodb-binaries

  - &restore-node-modules-cache
    keys:
      - v0-node-modules-{{ checksum "yarn.lock" }}
  - &save-node-modules-cache
    paths:
      - node_modules
    key: v0-node-modules-{{ checksum "yarn.lock" }}

  # commands
  - &yarn
    name: Install Dependencies
    command: yarn install --frozen-lockfile --production=false --non-interactive --cache-folder ~/.cache/yarn
  - &lint |
    yarn jest:lint
  - &test
    name: Run Tests
    command: |
      yarn relay:web
      yarn relay:app
      yarn jest --maxWorkers=4 --coverage --forceExit --ci
      bash <(curl -s https://codecov.io/bash)
  - &check-changes
    name: Check changes
    command: |
      .circleci/check_changes.sh
  - &build_docker_image_server
    name: Build the Docker image
    command: |
      docker build --rm=false \
        -f ./packages/server/Dockerfile \
       -t $IMAGE_NAME_SERVER .
      docker images

  # Job Filters

  # Run only for not master branches
  - &filter-only-not-master
    branches:
      ignore:
        - master
  # runs only for master, and no tags
  - &filter-only-master
    branches:
      only:
        - master
  # Run only for master and tags
  - &filter-only-master-and-tags
    tags:
      only:
        - /.*/
    branches:
      only:
        - master

defaults: &defaults
  environment:
    IMAGE_NAME_SERVER: "server"
    K8S_DEPLOYMENT_SERVER: "server"
  working_directory: ~/app
  docker:
    - image: circleci/node:lts
    - image: circleci/redis:4.0.9

version: 2
jobs:
  install_deps:
    <<: *defaults
    steps:
      - checkout
      - restore_cache: *restore-yarn-cache
      - restore-cache: *restore-node-modules-cache
      - run: *yarn
      - save_cache: *save-node-modules-cache
      - save_cache: *save-yarn-cache
      - persist_to_workspace:
          root: .
          paths: .

  lint:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run: *lint

  test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - restore_cache: *restore-mongodb-binaries-cache
      - run: *test
      - save_cache: *save-mongodb-binaries-cache
      - store_test_results:
          path: ./test-results

  build_server:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - setup_remote_docker
      - run: *build_docker_image_server

  check_changes:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run: *check-changes

workflows:
  version: 2
  full:
    jobs:
      - install_deps
      - lint:
          requires:
            - install_deps
      - test:
          requires:
            - install_deps
      - build_server:
          filters: *filter-only-master-and-tags
          requires:
            - lint
            - test
      - check_changes:
          filters: *filter-only-master-and-tags
          requires:
            - install_deps
